import telebot
import urllib.parse
import requests
from googleapiclient.discovery import build
from google.oauth2 import service_account

mytoken = '6304714665:AAGP55lkqyWhjEj0piwAI-2OGQPoJbeOJps'
yandex_api_key = '19ece416-3675-4926-8215-74f3af2d0328'
google_credentials_file = 'credentials.json'  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ Google

bot = telebot.TeleBot(mytoken)

# –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Google
google_credentials = service_account.Credentials.from_service_account_file(google_credentials_file)
google_service = build('sheets', 'v4', credentials=google_credentials)

@bot.message_handler(commands=['start'])
def welcome(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    button1 = telebot.types.KeyboardButton('üîé –ü–æ–∏—Å–∫')
    button2 = telebot.types.KeyboardButton('‚òé –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏')
    markup.row(button1, button2)

    if message.text == '/start':
        bot.send_message(message.chat.id, f'–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!\n–£ –º–µ–Ω—è –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–∞—Å –¥–µ—Ç–∞–ª–∏ –∏ –∑–∞–ø—á–∞—Å—Ç–∏!', reply_markup=markup)
    else:
        bot.send_message(message.chat.id, '–í—ã –ø–µ—Ä–µ—à–ª–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é!', reply_markup=markup)

@bot.message_handler(content_types=['photo'])
def get_photo(message):
    bot.send_message(message.chat.id, '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –º–æ–≥—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∏–≤–∞—Ç—å –≤–∞—à–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏!')

@bot.message_handler(func=lambda message: True)
def info(message):
    if message.text == 'üîé –ü–æ–∏—Å–∫':
        searchChapter(message)
    elif message.text == '‚òé –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏':
        contactsChapter(message)
    elif message.text == '‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é':
        welcome(message)
    else:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–∏—Å–∫ –≤ Google Sheets –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        search_text = message.text
        search_result = search_google_sheets(search_text)
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ —á–∞—Ç –±–æ—Ç–∞
        bot.send_message(message.chat.id, search_result)

def search_yandex(query):
    url = f"https://yandex.com/search/?text={urllib.parse.quote(query)}"
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'
    }
    response = requests.get(url, headers=headers)
    response.raise_for_status()
    return response.url

def searchChapter(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    button2 = telebot.types.KeyboardButton('‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é')
    markup.row(button2)
    bot.send_message(message.chat.id, '–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –¥–µ—Ç–∞–ª–∏', reply_markup=markup)

def contactsChapter(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    button2 = telebot.types.KeyboardButton('‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é')
    markup.row(button2)
    bot.send_message(message.chat.id, '–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏.\n–ù–æ–º–µ—Ä –¥–ª—è —Å–≤—è–∑–∏: 891234567899\n–¢–µ–ª–µ–≥—Ä–∞–º –¥–ª—è —Å–≤—è–∑–∏: —Ç—É—Ç –¢–ì\n–ù–∞—à–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ –ê–≤–∏—Ç–æ: —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –∞–≤–∏—Ç–æ.', reply_markup=markup)

def search_google_sheets(query):
    sheet_id = '15t66KFUifbcw4LMrb1rm8_-uAmG78hPd1dFshMHvo_g'
    sheet_range = ''  # –£–¥–∞–ª–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –∏—Å–∫–∞—Ç—å –≤–æ –≤—Å–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ

    sheet = google_service.spreadsheets()
    result = sheet.values().get(spreadsheetId=sheet_id, range=sheet_range).execute()
    values = result.get('values', [])

    # –ü–æ–∏—Å–∫ –∑–Ω–∞—á–µ–Ω–∏—è query –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    search_result = ""
    for row in values:
        if query in row:
            search_result += ", ".join(row) + "\n"

    if search_result:
        return search_result
    else:
        return "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."

bot.polling(none_stop=True)
